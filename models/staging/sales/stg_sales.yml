version: 2

models:
  - name: stg_sales__order_header
    description: "Cleaned order headers for downstream marts."
    columns:
      - name: sales_order_id
        description: "Natural key of the order header."
        tests: [not_null, unique]

      - name: order_date
        description: "Order creation date."
        tests: [not_null]

      - name: status_code
        description: "Numeric status code; mapped to a name via seed downstream."
        tests: [not_null]

      - name: customer_id
        description: "FK to sales customer."

      - name: ship_to_address_id
        description: "FK to ship-to address."

      - name: credit_card_id
        description: "FK to credit card used in the order (nullable)."

      - name: subtotal_amount
        description: "Sum of line amounts before taxes and freight."
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"
              severity: warn

      - name: tax_amount
        description: "Total taxes charged on the order."
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"
              severity: warn

      - name: freight_amount
        description: "Shipping freight amount."
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"
              severity: warn

      - name: total_due_amount
        description: "Final amount due (subtotal + tax + freight)."
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"
              severity: warn

    tests:
      - dbt_utils.expression_is_true:
          expression: "abs(total_due_amount - (subtotal_amount + tax_amount + freight_amount)) <= 0.01"
          severity: warn

  - name: stg_sales__order_detail
    description: "Cleaned order line items for downstream marts."
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns: [sales_order_id, sales_order_detail_id]

    columns:
      - name: sales_order_id
        description: "FK to order header."

      - name: sales_order_detail_id
        description: "Line identifier inside an order."

      - name: product_id
        description: "FK to product."

      - name: order_qty
        description: "Quantity ordered."

      - name: unit_price
        description: "Unit price applied on the line."

      - name: unit_price_discount
        description: "Unit discount applied on the line (0..1)."

  - name: stg_sales__customer
    description: "Cleaned customers unified from person/store with a single display name."
    columns:
      - name: customer_id
        description: "Natural key of the customer."
        tests: [not_null, unique]

      - name: customer_type
        description: "Customer kind derived from available link (Person / Store / Unknown)."
        tests:
          - accepted_values:
              values: ['Person', 'Store', 'Unknown']
              severity: warn

      - name: customer_name
        description: "Display name: store name or person full name."
        tests: [not_null]
                  
      - name: person_id
        description: "FK to person (nullable for store customers)."

      - name: store_id
        description: "FK to store (nullable for person customers)."

  - name: stg_sales__credit_card
    description: "Credit card reference from OLTP with the minimal fields used downstream."
    columns:
      - name: credit_card_id
        description: "Natural key of the credit card."
        tests: [not_null, unique]

      - name: card_type
        description: "Card brand/type (e.g., Vista, SuperiorCard, etc.)."
        tests: [not_null]

  - name: stg_sales__sales_reason
    description: "Sales reasons (e.g., Promotion, Marketing) cleaned for downstream marts."
    columns:
      - name: sales_reason_id
        description: "Natural key of the sales reason."
        tests: [not_null, unique]
      - name: reason_name
        description: "Human-friendly reason name."
        tests: [not_null]
      - name: reason_type
        description: "Reason grouping/type (e.g., Promotion, Marketing, Other)."
        tests: [not_null]

  - name: stg_sales__order_sales_reason
    description: "Bridge between orders and sales reasons (M:N)."
    columns:
      - name: sales_order_id
        description: "Order natural key."
      - name: sales_reason_id
        description: "Sales reason natural key."



