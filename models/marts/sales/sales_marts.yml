version: 2

models:
  - name: dim_product
    description: "Product dimension built from staging (1 row per product)."
    columns:
      - name: product_key
        description: "Surrogate key (hash of product_id)."
        tests: [not_null, unique]

      - name: product_id
        description: "Natural key from OLTP (Production.ProductID)."
        tests: [not_null]

      - name: product_name
        description: "Product display name."
        tests: [not_null]

      - name: product_subcategory_name
        description: "Optional subcategory name for the product."

      - name: product_category_name
        description: "Optional category name for the product."

  - name: dim_customer
    description: "Customer dimension (person or store) with a single display name."
    columns:
      - name: customer_key
        description: "Surrogate key for the customer (hash of customer_id)."
        tests: [not_null, unique]

      - name: customer_id
        description: "Natural key from source (SALES_CUSTOMER.CustomerID)."
        tests: [not_null, unique]

      - name: customer_type
        description: "Customer classification: Store, Person, or Unknown."
        tests:
          - accepted_values:
              values: ['Store', 'Person', 'Unknown']
              severity: warn

      - name: customer_name
        description: "Display name (store name or person full name)."
        tests: [not_null]

      - name: person_id
        description: "Lineage: FK to PERSON when type=Person (nullable)."

      - name: store_id
        description: "Lineage: FK to STORE when type=Store (nullable)."

  - name: dim_credit_card
    description: "Credit card dimension (brand/type and expiration)."
    columns:
      - name: credit_card_key
        description: "Surrogate key (hash of credit_card_id)."
        tests: [not_null, unique]

      - name: credit_card_id
        description: "Natural key from SALES_CREDITCARD."
        tests: [not_null, unique]

      - name: card_type
        description: "Credit card brand/type"
        tests: [not_null]

  - name: dim_geography
    description: "Geography dimension at City–State–Country grain (ship-to)."
    columns:
      - name: geography_key
        description: "Surrogate key (hash of country_code, state_province_code, city)."
        tests: [not_null, unique]

      - name: city
        description: "City (ship-to)."
        tests: [not_null]

      - name: state_province
        description: "State/Province name."
        tests: [not_null]

      - name: state_province_code
        description: "State/Province code (from source)."
        tests: [not_null]

      - name: country
        description: "Country/Region name."
        tests: [not_null]

      - name: country_code
        description: "Country/Region code."
        tests: [not_null]

  - name: dim_sales_reason
    description: "Sales reason dimension (e.g., Promotion, Marketing) with surrogate key."
    columns:
      - name: sales_reason_key
        description: "Surrogate key (hash of SR0 + sales_reason_id)."
        tests: [not_null, unique]

      - name: sales_reason_id
        description: "Natural key from SALES_SALESREASON."
        tests: [not_null, unique]

      - name: reason_name
        description: "Sales reason name."
        tests: [not_null]

      - name: reason_type
        description: "Category/type of sales reason."
        tests: [not_null]

  - name: bridge_sales_reason
    description: "Bridge table linking orders to sales reasons (M:N)."
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns: [order_id, sales_reason_key]
    columns:
      - name: order_id
        description: "Natural key of the order (from SALESORDERHEADER)."
        tests: [not_null]

      - name: sales_reason_key
        description: "FK to dim_sales_reason."
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('dim_sales_reason')
                field: sales_reason_key

  - name: dim_date
    description: "Calendar dimension (one row per day) for time-based analysis."
    columns:
    - name: date_key
      description: "Surrogate key generated from date_day (prefix DT0)."
      tests: [not_null, unique]

    - name: date_day
      description: "Actual date."
      tests: [not_null, unique]

    - name: year
      description: "Year of the date."
      tests: [not_null]

    - name: month_number
      description: "Month number (1–12)."
      tests: [not_null]

    - name: month_name
      description: "Abbreviated month name (Jan, Feb, ...)."
      tests: [not_null]

    - name: year_month
      description: "Year-month string (YYYY-MM)."
      tests: [not_null]

    - name: year_month_sort
      description: "Numeric key (YYYYMM) used for chronological sorting of year_month."
      tests: [not_null, unique]

  - name: fct_sales
    description: >
      Fact table at order line grain. Each row represents one sales order detail
      with foreign keys to product, customer, credit card, geography, date,
      and order status. Includes gross, discount, net amounts, and quantity.
    columns:
      - name: sales_order_line_key
        description: "Surrogate key (hash of sales_order_id + sales_order_detail_id)."
        tests: [not_null, unique]

      - name: sales_order_id
        description: "Natural key of the sales order (header)."
        tests: [not_null]

      - name: sales_order_detail_id
        description: "Natural key of the line item within the order."
        tests: [not_null]

      - name: product_key
        description: "FK to dim_product."
        tests:
          - not_null
          - relationships:
              to: ref('dim_product')
              field: product_key

      - name: customer_key
        description: "FK to dim_customer."
        tests:
          - not_null
          - relationships:
              to: ref('dim_customer')
              field: customer_key

      - name: credit_card_key
        description: "FK to dim_credit_card."
        tests:
          - relationships:
              to: ref('dim_credit_card')
              field: credit_card_key
              severity: warn
      - name: credit_card_id
        description: Natural key from source system. -1 when not informed.
      - name: card_type
        description: Credit card type. "Unknown" when not informed.

      - name: geography_key
        description: "FK to dim_geography."
        tests:
          - not_null
          - relationships:
              to: ref('dim_geography')
              field: geography_key

      - name: order_date_key
        description: "FK to dim_date."
        tests:
          - not_null
          - relationships:
              to: ref('dim_date')
              field: date_key

      - name: order_status_key
        description: "FK to dim_order_status."
        tests:
          - not_null
          - relationships:
              to: ref('dim_order_status')
              field: order_status_key

      - name: status_code
        description: "Numeric order status code from the source (kept for audit)."
        tests: [not_null]

      - name: order_qty
        description: "Quantity purchased."
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: ">= 1"

      - name: gross_amount
        description: "Gross sales (unit_price * order_qty)."
        tests: [not_null]

      - name: discount_amount
        description: "Discount amount (gross * unit_price_discount)."

      - name: net_amount
        description: "Net sales (gross - discount)."
        tests: [not_null]

  - name: dim_order_status
    description: "Order status dimension (seed-based mapping from numeric code to readable name)."
    columns:
      - name: order_status_key
        description: "Surrogate key for order status."
        tests: [not_null, unique]

      - name: status_code
        description: "Numeric status code from the source system."
        tests:
          - not_null
          - unique

      - name: status_name
        description: "Human-readable status label."
        tests: [not_null]

  